<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<!--
Design by TEMPLATED
http://templated.co
Released for free under the Creative Commons Attribution License

Name       : ColoreGiallo 
Description: A two-column, fixed-width design with dark color scheme.
Version    : 1.0
Released   : 20121026

-->
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta name="keywords" content="" />
<meta name="description" content="" />
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<title>GEF4530 - Practicals D2 - Post-processing and Visualization</title>
<link href='http://fonts.googleapis.com/css?family=Oswald:400,300' rel='stylesheet' type='text/css' />
<link href='http://fonts.googleapis.com/css?family=Abel|Satisfy' rel='stylesheet' type='text/css' />
<link href="../../style.css" rel="stylesheet" type="text/css" media="screen" />
</head>
<body>
        
<h1>Post-processing and Visualization</h1>

You will be using both cruncher (cruncher.norstore.uio.no) and viz2 (viz2.norstore.uio.no) to post-process your data (cruncher) and visualize your data (viz2).
<br>
<ul>
<li> <a href="#Panoply">Visualize your model outputs with Panoply</a></li>
<li><a href="#Workflow">Post-processing workflow: example with the control experiment</li>
<li><a href="#SPARC">SPARC climatology</a></li>
<li><a href="#Ex1">Exercice-1</a></li>
<br>
<h4 id="Panoply">Visualization with Panoply</h4>

Panoply is installed on norStore visualization platform viz2 (viz2.norstore.uio.no). To ease the usage of viz2, we have created a script to connect and set-up your environment.
<br>
Make sure you have all the requirements for using viz2. See <a href="../D1/setup_laptops.html#Visualization">here</a> to set-up your laptop or local machine.

<br>
<ul>
<li><a href="../D1/setup_laptops.html#ssh_keys_viz2">Set SSH keys for viz2</a></li>
<li><a href="../D1/setup_laptops.html#turboVNC_viz2">Install TurboVNC 2.0.1</a>. This step is not required if you use a student machine in Room 209 or at METOS. If you wish to visualize your data from your laptop, install on your machine <a href="http://sourceforge.net/projects/turbovnc/files/2.0.1/">turbovnc 2.0.1</a>. For Mac users, download <a href="https://sourceforge.net/projects/turbovnc/files/2.0.1/TurboVNC-2.0.1-OracleJava.dmg/download">TurboVNC-2.0.1-OracleJava.dmg</a>. The "OracleJava" TurboVNC package is now the default Mac package, since Oracle Java performs much better than Apple's (deprecated) Java distribution on OS X 10.10 "Yosemite" and later. Contact us if you need any help.</li>
<li><a href="../D1/setup_laptops.html#ConnectViz2">Get norstoreVizWIN.sh script on your local machine</a></li>
</ul>
Here we assume the two previous steps have been performed and you have launched <b>norstoreVizWIN.sh</b>.
<br>
After starting norstoreVizWIN.sh, a new TurboVNC window should appear:
<br>
<img src="../../images/turboVNC.png" align="middle" width="600" alt="" />
<br>
with a terminal you can use to visualize your data. We will refer it as TurboVNC Terminal and all commands to visualize your data will be performed in this terminal.
<br>
<font color="red">In your TurboVNC terminal</font>:
<code>
<pre>
panoply.sh
</pre>
</code>
<br>
When typing the command above, a window should pop-up with a File browser.
<br>
<br>
<img src="../../images/panoply_p0.png" align="middle" alt="" />
<br>
<br>
In the field "File Name", write "/projects/NS1000K/GEF4530/outputs" and then enter. This should move to /projects/NS1000K/GEF4530/outputs directory.
<br>
And browse in you $USER directory then to archive/f2000.T31T31.test/atm/hist and select and double-click (left button) either f2000.T31T31.test.cam.h0.0001-01-01-00000.nc or f2000.T31T31.test.cam.h0.0001-01-31-00000.nc. Here we show plots using f2000.T31T31.test.cam.h0.0001-01-01-00000.nc.
<br>
<br>
<img src="../../images/panoply_p1.png" align="middle" alt="" />

<br>
<br>
<b>Geographical map</b>
<br>
Select (double click) for instance "T" to visualize the temperature (4D variables):
<br>
<img src="../../images/panoply_p2.png" align="middle" alt="" />
<br>
<br>
And click on "create". The temperature field will then appear:

<img src="../../images/panoply_p3.png" align="middle" alt="" />
<br>
<br>
Take a few minutes to check and understand your plot:
<font color="red">
<ul>
<li>Which Time did you plot?</li>
<li>Which level did you plot?</li>
</ul>
</font>
<br>
By default, panoply will plot the first level. And the first level for CAM 5.3 corresponds to 3.64347 sigma pressure level... 
<br>
If you change from 1 to 30 (last CAM 5.3 model level i.e. level close to the surface), the color scale won't be changed (and is set with min/max temperature at the top of the atmosphere):
<br>
<br>
<img src="../../images/panoply_p4.png" align="middle" alt="" />
<br>
<br>
In Panoply, select tab "Scale" (at the bottom), and click on "Always fit to data":
<br>
<br>
<img src="../../images/panoply_p5.png" align="middle" alt="" />
<br>
You can save your plot as an image (png format).
<br>
<br>
<b>Georeferenced Latitude-Vertical plot</b>
<br>
As for lat/lon 2D map, click on "Create Plot" and in "create georeferenced" select "Latitude-Vertical" instead of "Longitude-Latitude".
<br>
<br>
<img src="../../images/panoply_p6.png" align="middle" alt="" />
<br>
<br>
Like for geographical map, take a few minutes to analyze your plot.
<br>
The vertical axis is labelled as "hybrid level at midpoints". Again, not pressure levels but still we usually use the log to plot it as it is more intuitive to analyze. For this, go to the tab "Grid" and change the units of the vertical axis from "scalar" to "Log10".
<br>
<br>

<img src="../../images/panoply_p7.png" align="middle" alt="" />
<br>
<br>
You can use panoply to plot other variables and make different kind of plots. We will now look at the control experiment (stored on norStore).

<h4 id="Workflow">Post-processing workflow: example with the control experiment</h4>

The control experiment (which you have used to restart your 1 month experiment) results have been stored on norstore. 
<br>
<font color="red">On cruncher (cruncher.norstore.uio.no):</font>
<br>
<code>
<pre>
cd /projects/NS1000K/GEF4530/outputs/archive/f2000.T31T31.control/atm/hist
</pre>
</code>
<br>
<font color="red">
<ul>
<li>How many years did we run?</li>
<li>What is the output frequency?</li>
</ul>
</font>
<br>
Feel free to use viz2 and visualize the model outputs from this control experiment. As you can see, analyzing output simulations that span over several years can be cumbersome.
<br>
We usually post-process our model outputs before visualization:
<ol>
<li><a href="#Select">Select variables of interest</a></li>
<li><a href="#mean">Compute monthly/yearly/zonal mean</a></li>
<li><a href="#h2P">Convert to Pressure levels and visualize</a></li>
</ol>
Conversion to Pressure levels (Step-3) may not mandatory but often necessary if you wish to compare with observations or other models.
<br>
Step-2 depends on what results you wish to get. With climate models, it is unlikely you analyze daily data as simulations span over several years/decades.
<br>
<br>
<b>Cruncher</b> (cruncher.norstore.uio.no) is a machine you can use to post-process your model outputs once you have <a href="norstore.html">stored them on norStore</a>.

<br>

<h5>Setup on cruncher</h5>

Login on <b>cruncher</b> (see <a href="https://pages.github.uio.no/annefou/GEF4530/practicals/D1/setup_laptops.html">here</a> if you need help).
<br>
Then set-up your environment to access all the tools we will be using on cruncher:
<br>
<code>
<pre>
export PATH=/projects/NS1000K/panoply/4.4.3/:$PATH
module load cdo
module load ncl
</pre>
</code>

For more information see <a href="https://pages.github.uio.no/annefou/GEF4530/results/setup.html">here</a>.

<h5 id="Select">Select variables of interest</h5>
Each model output file contains a large number of variables while you may be interested in a few of them only. To select variables, you may use <a href="http://nco.sourceforge.net/nco.html#ncks-netCDF-Kitchen-Sink">ncks</a>, a tool part of the <a href="http://nco.sourceforge.net/">nco</a> tool suite.
<br>
For instance, <font color="red">on cruncher</font>:
<code>
<pre>
mkdir -p $HOME/GEF4530/control
ncks -v T f2000.T31T31.control.cam.h0.0005-01-11-00000.nc $HOME/GEF4530/control/f2000.T31T31.control.cam.h0.0005-01-11-00000_T.nc
</pre>
</code>
<br>
It extracts T (Temperature) from the netCDF file f2000.T31T31.control.cam.h0.0005-01-11-00000.nc and store the result in a new netCDF file $HOME/GEF4530/control/f2000.T31T31.control.cam.h0.0005-01-11-00000_T.nc
<br>
If you want to select more variables (not only the temperature), you can give the list of variables you wish to select (comma separated). 
<br>
For instance (here for two different input files):
<br>
<code>
<pre>
ncks -v T,U,hyam,hybm,PS f2000.T31T31.control.cam.h0.0004-12-12-00000.nc $HOME/GEF4530/control/f2000.T31T31.control.cam.h0.0004-12-12-00000_TU.nc
ncks -v T,U,hyam,hybm,PS f2000.T31T31.control.cam.h0.0005-01-11-00000.nc $HOME/GEF4530/control/f2000.T31T31.control.cam.h0.0005-01-11-00000_TU.nc
</pre>
</code>
and select T, U, hyam, hybm and PS. These variables (hyam, hybm and PS) will be required to interpolate <a href="#h2P">T and U on pressure levels</a>.
<br>
Remember that your new netCDF files are stored in your HOME area ($HOME/GEF4530/control/).
<br>
<font color="red">
<ul>
<li>Use panoply to visualize your new netCDF files</li>
<li>Use a <a href="https://pages.github.uio.no/annefou/GEF4530/results/shell.html">shell loop</a> to extract T and U (and hyam, hybm and PS) from all the model outputs (control experiment) and store the resulting netCDF files in $HOME/GEF4530/control/</li>
</ul>
</font>
<br>
<h5 id="mean">Compute monthly/yearly mean</h5>
<h6 id="monmean">Monthly mean</h6>
You can use <a href="https://code.zmaw.de/projects/cdo">CDO</a> or <a href="http://nco.sourceforge.net">NCO</a> or python.
<br>
Here we show you how to use <a href="http://nco.sourceforge.net">NCO</a>.
<br>
To compute the average of each variable present in your netCDF files, you can use <a href="http://nco.sourceforge.net/nco.html#ncra-netCDF-Record-Averager">ncra</a>:
<code>
<pre>
cd /projects/NS1000K/GEF4530/outputs/archive/f2000.T31T31.control/atm/hist/

ncra f2000.T31T31.control.cam.h0.0004-01-*.nc f2000.T31T31.control.cam.h0.0005-01-*.nc $HOME/GEF4530/control/f2000.T31T31.control-0005-01-monmean.nc
</pre>
</code>
<br>
If you don't specify any time, the average is done over all the time period available in your netCDF files. To be more precise and for instance to compute the monthly average for January from the fifth year of our control experiment:
<br>
<code>
<pre>
cd /projects/NS1000K/GEF4530/outputs/archive/f2000.T31T31.control/atm/hist/

ncra -d time,1461.,1492. f2000.T31T31.control.cam.h0.0004-01-*.nc f2000.T31T31.control.cam.h0.0005-01-*.nc $HOME/GEF4530/control/f2000.T31T31.control-0005-01-monmean.nc
</pre>
</code>
<br>
Adding a time option (<b>-d time,1461.,1492.</b>) allows you to specify over which time period, the average is done (here between day 1461 to day 1492).
<br>
<br>
The calendar in the CESM time manager is the 365 day or no-leap calendar. 
This calendar has the standard 12 months, but it has 365 days every year and 28 days in every February. 
<br>
Our CAM 5.3 control experiment started from 0001-01-01 00:00:0.0. This can be checked for instance using ncdump:
<br>
<code>
<pre>
ncdump -h f2000.T31T31.control.cam.h0.0001-01-01-00000.nc
</pre>
</code>
<br>
You will get:
<code>
<pre>
	double time(time) ;
		time:long_name = "time" ;
		time:units = "days since 0001-01-01 00:00:00" ;
		time:calendar = "noleap" ;
		time:bounds = "time_bnds" ;
</pre>
</code>
<br>
To compute the monthly mean for January Year 5, we need two input files f2000.T31T31.control.cam.h0.0004-12-12-00000.nc and f2000.T31T31.control.cam.h0.0005-01-11-00000.nc because f2000.T31T31.control.cam.h0.0005-01-11-00000.nc does not contain the entire January month (starts from 11th of January).
<br>
You can use ncview to check the start and end time for each file.
<br>
With this last command, we computed the average for all the variables, while we know it won't be necessary (for our climatology, we only need T and U). 
<font color="red">
<ul>
<li>Apply ncra to compute the average (January, year 5) on the netCDF files you first created (after ncks).</li>
<li>You can use <a href="https://pages.github.uio.no/annefou/GEF4530/results/shell.html">shell loops</a> to compute the average for every month and then get 12 output files (one per month)</li>
</ul>
</font>
<br>
<b>Remark:</b>
<br>
We have run 8 years in our control run. However, we usually do not use the first years (model spin up) and here you may keep the last 5 years only. If you have time you may compare results when averaging over 8 years or 5 years.
<br>
<br>
<h6 id="zonalmean">Zonal mean</h6>
If you wish to compute zonal mean, you may use NCL. <a href="http://www.ncl.ucar.edu/Applications/zonal.shtml">Here</a> you will find several examples to compute and plot zonal means.

<br>
The example that is the most suitable for our study is <a href="http://www.ncl.ucar.edu/Applications/Scripts/zonal_2.ncl">zonal_2.ncl</a>. It uses <a href="http://www.ncl.ucar.edu/Document/Functions/Contributed/dim_avg_Wrap.shtml">dim_avg_Wrap</a> to compute the average of a variable's rightmost dimension at all other dimensions and retains metadata.
<br>
<br>
<h5 id="h2P">Convert to Pressure levels</h5>

To convert CAM 5.3 model outputs to pressure levels, the easiest is to use ncl <a href="http://www.ncl.ucar.edu/Applications/vert_interp.shtml">vertical interpolation</a> routines and in particular <a href="http://www.ncl.ucar.edu/Document/Functions/Built-in/vinth2p.shtml">vinth2p</a>.
<br>
To use <b>vert_1.ncl</b> to convert <b>f2000.T31T31.control-0005-01-monmean.nc</b> (January mean from the fifth year of our control experiment) to pressure level:
<ol>
<li>Download <a href="http://www.ncl.ucar.edu/Applications/Scripts/vert_1.ncl">vert_1.ncl</a> and transfer it to cruncher. Here we assume you have your vert_1.ncl script in <b>$HOME/GEF4530/control/</b>.</li>
<li>Edit vert_1.ncl (use your favourite editor such as emacs) and change the input file name:/li>
<code>
<pre>
fn  = "f2000.T31T31.control-0005-01-monmean.nc" ; define filename
</pre>
</code>
<br>
<li>Then run your script with ncl <font color="red">on cruncher</font>:</li>
<br>
<code>
<pre>
module load ncl

ncl vert_1.ncl
</pre>
</code>
</ol>
<br>
vert_1.ncl interpolates the temperature to the following pressure levels:
<code>
<pre>
  pnew = (/ 850.0,700.0,500.0,300.0,200.0 /)        
</pre>
</code>
<br>
And it creates contour plots of temperature at 850 mb, 500 mb and 200mb. You can of course change the code (for instance change the list of pressure levels in <b>pnew</b> and generate different plots. If you want to interpolate a different variable to pressure level, you need to change the variable read from the netCDF file:
<code>
<pre>
T = in->T  
</pre>
</code> 
<br>
The variable names can be found using for instance ncview (or ncdump -h where the option "-h" means to dump the header/metadata of the netCDF file only).
<br>
If you wish to store the resulting field to a new netCDF file, see <a href="https://www.ncl.ucar.edu/Applications/o-netcdf.shtml">here</a>. Let us know if you need more help.
<br>
All the interpolation routines from NCL are available <a href="http://www.ncl.ucar.edu/Applications/vert_interp.shtml">here</a>.
<br>
<h4 id="SPARC"><a href="http://www.sparc-climate.org/data-center/data-access/reference-climatologies/randels-climatologies/temperature-wind-climatology/">SPARC climatology</a></h4>
<br>
<br>
The SPARC climatology T and U is stored in a file called <b>sparc.nc</b> and can be found on norStore:
<br>
<code>
<pre>
cd /projects/NS1000K/GEF4530/SPARC
</pre>
</code>
<br>
A ncl script is available in the same directory (<a href="https://www.ncl.ucar.edu/Applications/Scripts/sparc_2.ncl">sparc_2.ncl</a>) and can be used to generate two plots (png file):
<ul>
<li>Create sparc directory in your HOME on norStore:</li>
<code>
<pre>
mkdir -p $HOME/GEF4530/sparc
cd $HOME/GEF4530/sparc
</pre>
</code>
<li>copy sparc_2.ncl in your local directory:</li>
<code>
<pre>
cp /projects/NS1000K/GEF4530/SPARC/sparc_2.ncl $HOME/GEF4530/sparc/.
</pre>
</code>
<li>Edit <b>$HOME/GEF4530/sparc/sparc_2.ncl</b> and change <b>diri</b> (it specifies the directory where sparc.nc can be found). It is by default set to <b>"./"</b> and should be set to:</li>

<code>
<pre>
diri="/projects/NS1000K/GEF4530/SPARC/"
</pre>
</code>
<li>Save your script and run ncl:</li>
<code>
<pre>
ncl sparc_2.ncl
</pre>
</code>
<br>
You can visualize png images using <b>display</b>:
<code>
<pre>
display sparc.000001.png
</pre>
</code>
<br>
<b>sparc.000001.png</b> shows the monthly temperature climatologies (K) for each month from January to December.
<br>
<img src="../../images/sparc.000001.png" align="middle" alt="" />
<br>
<b>sparc.000002.png</b> shows the monthly wind climatologies (m/s) for each
 month from January to December.
<br>
<img src="../../images/sparc.000002.png" align="middle" alt="" />
<br>
<br>
<h4 id="Ex1">Exercice-1</h4>
<br>
<ol>
<li><font color="red">How well does CAM5 (T31/L30, 5 yr control run) represent observations?</font></li>
</ol>
<br>
To answer to this question, plot T and U and compare with the SPARC data climatology (online on norstore).
<br>
<br>
We give here some suggestions on how to proceed (feel free to use your own method!):
<br>
<br>
<ol>
<li>Select T,U,hyam,hybm,PS (use ncks) for all the model outputs of the control experiment (/projects/NS1000K/GEF4530/outputs/archive/f2000.T31T31.control/atm/hist). Save these new output files in the directory $HOME/GEF4530/control/.</li>
<li>For each year (you may start from year 4 to year 8), compute the monthly average using ncra.</li>
<li>Use ncra again to get an average for all the January months. Repeat it for each month (February to December).</li>
<li>Use <a href="http://www.ncl.ucar.edu/Applications/Scripts/zonal_2.ncl">zonal_2.ncl</a> and <a href="http://www.ncl.ucar.edu/Applications/Scripts/vert_1.ncl">vert_1.ncl</a> to get a zonal mean and interpolate to pressure levels. Make sure you choose your pressure levels (change the variable <b>pnew</b> in <a href="http://www.ncl.ucar.edu/Applications/Scripts/vert_1.ncl">vert_1.ncl</a> so you can easily compare with SPARC climatology).</li>
<li>You may use <a href="https://www.ncl.ucar.edu/Applications/Scripts/sparc_2.ncl">sparc_2.ncl</a> to get plots similar to those we got with the SPARC climatology. You can also use panoply (or python).</li>
</ol>

<br>
<font color="red">Fulfill the first exercise until the next practical on March 27, 2017!</font>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
</body>
</html>
