<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<!--
Design by TEMPLATED
http://templated.co
Released for free under the Creative Commons Attribution License

Name       : ColoreGiallo 
Description: A two-column, fixed-width design with dark color scheme.
Version    : 1.0
Released   : 20121026

-->
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta name="keywords" content="" />
<meta name="description" content="" />
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<title>GEF4530 - Practicals D2 - Post-processing and Visualization</title>
<link href='http://fonts.googleapis.com/css?family=Oswald:400,300' rel='stylesheet' type='text/css' />
<link href='http://fonts.googleapis.com/css?family=Abel|Satisfy' rel='stylesheet' type='text/css' />
<link href="../../style.css" rel="stylesheet" type="text/css" media="screen" />
</head>
<body>
        
<h1>Post-processing and Visualization</h1>

You will be using both cruncher (cruncher.norstore.uio.no) and viz2 (viz2.norstore.uio.no) to post-process your data (cruncher) and visualize your data (viz2).
<br>
<ul>
<li> <a href="#Panoply">Visualize your model outputs with Panoply</a></li>
<li><a href="#Workflow">Post-processing workflow: example with the control experiment</li>
<li><a href="#SPARC">SPARC climatology</a></li>
<li><a href="#Ex1">Exercice-1</a></li>
<br>
<h4 id="Panoply">Visualization with Panoply</h4>

Panoply is installed on norStore visualization platform viz2 (viz2.norstore.uio.no). To ease the usage of viz2, we have created a script to connect and set-up your environment.
<br>
Make sure you have all the requirements for using viz2. See <a href="../D1/setup_laptops.html#Visualization">here</a> to set-up your laptop or local machine.

<br>
<ul>
<li><a href="../D1/setup_laptops.html#ssh_keys_viz2">Set SSH keys for viz2</a></li>
<li><a href="../D1/setup_laptops.html#ConnectViz2">Get norstoreVizWIN.sh script on your local machine</a></li>
</ul>
Here we assume the two previous steps have been performed and you have launched <b>norstoreVizWIN.sh</b>.
<br>
After starting norstoreVizWIN.sh, a new TurboVNC window should appear:
<br>
<img src="../../images/turboVNC.png" align="middle" width="600" alt="" />
<br>
with a terminal you can use to visualize your data. We will refer it as TurboVNC Terminal and all commands to visualize your data will be performed in this terminal.
<br>
<font color="red">In your TurboVNC terminal</font>:
<code>
<pre>
panoply.sh
</pre>
</code>
<br>
When typing the command above, a window should pop-up with a File browser.
<br>
<br>
<img src="../../images/panoply_p0.png" align="middle" alt="" />
<br>
<br>
In the field "File Name", write "/projects/NS1000K/GEF4530/outputs" and then enter. This should move to /projects/NS1000K/GEF4530/outputs directory.
<br>
And browse in you $USER directory then to archive/f2000.T31T31.test/atm/hist and select and double-click (left button) either f2000.T31T31.test.cam.h0.0001-01-01-00000.nc or f2000.T31T31.test.cam.h0.0001-01-31-00000.nc. Here we show plots using f2000.T31T31.test.cam.h0.0001-01-01-00000.nc.
<br>
<br>
<img src="../../images/panoply_p1.png" align="middle" alt="" />

<br>
<br>
<b>Geographical map</b>
<br>
Select (double click) for instance "T" to visualize the temperature (4D variables):
<br>
<img src="../../images/panoply_p2.png" align="middle" alt="" />
<br>
<br>
And click on "create". The temperature field will then appear:

<img src="../../images/panoply_p3.png" align="middle" alt="" />
<br>
<br>
Take a few minutes to check and understand your plot:
<ul>
<li>Which Time did you plot?</li>
<li>Which level did you plot?</li>
</ul>
<br>
By default, panoply will plot the first level. And the first level for CAM 5.3 corresponds to 3.64347 sigma pressure level... 
<br>
If you change from 1 to 30 (last CAM 5.3 model level i.e. level close to the surface), the color scale won't be changed (and is set with min/max temperature at the top of the atmosphere):
<br>
<br>
<img src="../../images/panoply_p4.png" align="middle" alt="" />
<br>
<br>
In Panoply, select tab "Scale" (at the bottom), and click on "Always fit to data":
<br>
<br>
<img src="../../images/panoply_p5.png" align="middle" alt="" />
<br>
You can save your plot as an image (png format).
<br>
<br>
<b>Georeferenced Latitude-Vertical plot</b>
<br>
As for lat/lon 2D map, click on "Create Plot" and in "create georeferenced" select "Latitude-Vertical" instead of "Longitude-Latitude".
<br>
<br>
<img src="../../images/panoply_p6.png" align="middle" alt="" />
<br>
<br>
Like for geographical map, take a few minutes to analyze your plot.
<br>
The vertical axis is labelled as "hybrid level at midpoints". Again, not pressure levels but still we usually use the log to plot it as it is more intuitive to analyze. For this, go to the tab "Grid" and change the units of the vertical axis from "scalar" to "Log10".
<br>
<br>

<img src="../../images/panoply_p7.png" align="middle" alt="" />
<br>
<br>
You can use panoply to plot other variables and make different kind of plots. We will now look at the control experiment (stored on norStore).

<h4 id="Workflow">Post-processing workflow: example with the control experiment</h4>

The control experiment (which you have used to restart your 1 month experiment) results have been stored on norstore. 
<br>
<font color="red">On cruncher (cruncher.norstore.uio.no):</font>
<br>
<code>
<pre>
cd /projects/NS1000K/GEF4530/outputs/archive/f2000.T31T31.control/atm/hist
</pre>
</code>
<ul>
<li>How many years did we run?</li>
<li>What is the output frequency?</li>
</ul>
<br>
Feel free to use viz2 and visualize the model outputs from this control experiment. As you can see, analyzing output simulations that span over several years can be cumbersome.
<br>
We usually post-process our model outputs before visualization:
<ol>
<li><a href="#Select">Select variables of interest</a></li>
<li><a href="#mean">Compute monthly/yearly mean</a></li>
<li><a href="#h2P">Convert to Pressure levels and visualize</a></li>
</ol>
Step-2 may not mandatory but often necessary if you wish to compare with observations or other models.
<br>
Step-3 depends on what results you wish to analyze. With climate models, it is unlikely you analyze daily data as simulations span over several years/decades.
<br>
<br>
<b>Cruncher</b> (cruncher.norstore.uio.no) is a machine you can use to post-process your model outputs once you have <a href="norstore.html">stored them on norStore</a>.

<br>

<h5>Setup on cruncher</h5>

Login on <b>cruncher</b> (see <a href="https://pages.github.uio.no/annefou/GEF4530/practicals/D1/setup_laptops.html">here</a> if you need help).
<br>
Then set-up your environment to access all the tools we will be using on cruncher:
<br>
<code>
<pre>
export PATH=/projects/NS1000K/panoply/4.4.3/:$PATH
export PATH=/projects/NS1000K/python/anaconda/bin:$PATH
module load cdo
module load ncl
</pre>
</code>

For more information see <a href="https://pages.github.uio.no/annefou/GEF4530/results/setup.html">here</a>.

<h5 id="Select">Select variables of interest</h5>
Each model output file contains a large number of variables while you may be interested in a few of them only. To select variables, you may use <a href="http://nco.sourceforge.net/nco.html#ncks-netCDF-Kitchen-Sink">ncks</a>, a tool part of the <a href="http://nco.sourceforge.net/">nco</a> tool suite.
<br>
For instance, <font color="red">on cruncher</font>:
<code>
<pre>
mkdir -p $HOME/GEF4530/control
ncks -v T f2000.T31T31.control.cam.h0.0008-12-22-00000.nc $HOME/GEF4530/control/f2000.T31T31.control.cam.h0.0008-12-22-00000_T.nc
</pre>
</code>
<br>
It extracts T (Temperature) from the netCDF file f2000.T31T31.control.cam.h0.0008-12-22-00000.nc and store the result in a new netCDF file $HOME/GEF4530/control/f2000.T31T31.control.cam.h0.0008-12-22-00000_T.nc
<br>
Remember that your new netCDF file is stored in your HOME area ($HOME/GEF4530/control).
<br>
<ul>
<li>Use panoply to visualize your new netCDF file</li>
<li>Use a <a href="https://pages.github.uio.no/annefou/GEF4530/results/shell.html">shell loop</a> to extract T and U from all the model outputs (control experiment)</li>
</ul>
<br>
<h5 id="mean">Compute monthly/yearly mean</h5>
You can use <a href="https://code.zmaw.de/projects/cdo">CDO</a> or <a href="http://nco.sourceforge.net">NCO</a> (or python) to compute monthly average.
<br>
For instance, to compute the monthly average for January from the fifth year of our control experiment:
<br>
<code>
<pre>
cd /projects/NS1000K/GEF4530/outputs/archive/f2000.T31T31.control/atm/hist/
ncra -d time,1461,1492 f2000.T31T31.control.cam.h0.0005-01-*.nc $HOME/GEF4530/control/f2000.T31T31.control-0005-01-monmean.nc
</pre>
</code>
<br>
The calendar in the CESM time manager is the 365 day or no-leap calendar. 
This calendar has the standard 12 months, but it has 365 days every year and 28 days in every February. 
<br>
Our CAM 5.3 control experiment started from 0001-01-01 00:00:0.0. This can be checked for instance using ncdump:
<br>
<code>
<pre>
ncdump -h f2000.T31T31.control.cam.h0.0001-01-01-00000.nc
</pre>
</code>
<br>
You will get:
<code>
<pre>
	double time(time) ;
		time:long_name = "time" ;
		time:units = "days since 0001-01-01 00:00:00" ;
		time:calendar = "noleap" ;
		time:bounds = "time_bnds" ;
</pre>
</code>
<br>
<ul>
<li>You can use <a href="https://pages.github.uio.no/annefou/GEF4530/results/shell.html">shell loops</a> to compute the average for every month and then get 12 output files (one per month)</li>
</ul>
<br>
<b>Remark:</b>
<br>
We have run 8 years in our control run. However, we usually do not use the first years (model spin up) and here you may keep the last 5 years only. If you have time you may compare results when averaging over 8 years or 5 years.
<br>
See more <a href="https://pages.github.uio.no/annefou/GEF4530/results/analyze.html#usingcdo">here</a>.
<br>
<h5 id="h2P">Convert to Pressure levels</h5>

To convert CAM 5.3 model outputs to pressure levels, the easiest is to use ncl vertical interpolation routines <a href="http://www.ncl.ucar.edu/Document/Functions/Built-in/vinth2p.shtml">vinth2p</a>.

<br>
All the interpolation routines from NCL are available <a href="http://www.ncl.ucar.edu/Applications/vert_interp.shtml">here</a>.
<h4 id="SPARC">SPARC climatology</h4>
<br>
<h4 id="Ex1">Exercice-1</h4>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
</body>
</html>
